		<div>Comrades, Vaclav is speaking.</div>
		<h2>Winter is coming</h2>
		<div>The last session brought us some bad news. Through the session Johny rashly merged my last poisoned pull request. An application stopped with an error message. The fix was easy but we noticed problem after a deployment. The blog app worked just fine locally but this was not a case on Azure (we are using Azure as a hosting site for our node application). We did a quick analysis and realized that there is a problem with node.js version. Azure doesn’t support version which is requested by our Blog. We were not able to solve this problem until the end of the session. The app is currently off-line and winter is coming.</div>
		<h2>Does the dead frighten you?</h2>
		<div>Our app was dead and we were without a solution. I decided to use different approach. My plan was to create the Azure virtual machine, install node.js and run our Blog there. The problem was how to copy source code from github to the virtual machine automatically. This blog post will tell you the story.</div>
		<h2>Create azure virtual machine</h2>
		<div>The first step was to activate my Azure MSDN subscription and log into Azure web portal. It was easy to locate a button for Virtual Machines there. I needed to create a new one so I clicked on the big new button in the bottom. I chose Compute->Virtual Machine->From Gallery option. Let’s follow my steps:</div>
		
		</br>
		</br>
		<h4>Image 01: Creating new virtual machine</h4>
		<img src="/post4/AzureNewVM.jpg"/>

		</br>
		</br>
		<h4>Image 02: Choose operating system</h4>
		<img src="/post4/AzureNewVMServer.jpg"/>
		
		</br>
		</br>
		<h4>Image 03: Virtual machine configuration</h4>
		<img src="/post4/AzureNewVMConfiguration.jpg"/>
		
		</br>
		</br>
		<h4>Image 04: Virtual machine endpoint configuration</h4>
		<img src="/post4/AzureNewVMConfiguration2.jpg"/>

		<div>As you could see I chose Windows Server and what is important I preset FTP and HTTP endpoints.</div>
		<h2>Setup iis</h2>
		<div>If you are following me you will ask how to connect to our brand new virtual machine. It’s quite easy. We will use remote desktop. It is as easy as to click on the connect button on Azure Virtual Machine screen.</div>
		
		</br>
		</br>
		<h4>Image 05: Connecting to the virtual machine</h4>
		<img src="/post4/AzureVMConnect.jpg"/>

		<div>After this step we are inside the virtual machine and we have some work for the Server Manager. We need to install IIS. Go into Server Manager and then click on Manage->Add Roles and Features window. Server Manager will open a wizard window for you. Let’s go into server roles and choose Web Server (IIS). Here we need only two role services. FTP Server (FTP Service) and Management Tools (IIS Management Console).</div>
		
		</br>
		</br>
		<h4>Image 06: IIS installation</h4>
		<img src="/post4/AzureVMIIS1.jpg"/>
		
		</br>
		</br>
		<h4>Image 07: FTP server installation</h4>
		<img src="/post4/AzureVMIIS2.jpg"/>

		<h2>Setup ftp</h2>
		<div>We will need ftp user so let’s create him. In Server Manager click on Tools -> Computer management and add user as you can see on the picture below.</div>
		
		</br>
		</br>
		<h4>Image 08: New user</h4>
		<img src="/post4/AzureVMFTPUser.jpg"/>

		<div>Good. Now let’s go into IIS. In Server Manager click on Tools -> IIS Manager. In Connections panel right click on KPJSBLOGVM node and choose Add FTP Site. In the “Add FTP Site window” choose some fancy FTP site name for example “kpjs_deploy” and physical path – for example “C:\inetpub\ftproot\kpjs_deploy”. In next window choose offered IP address and click to “No SSL” (nobody ain't got time for that). In the last window choose Basic authentication and allow access to all users with read/write permissions. Click finish. Finally our FTP server is alive!</div>
		<div>NOTE: Don’t forget to add “ftpuser” to “kpjs_deploy” folder permissions. Give him read/write access rights.</div>
		
		</br>
		</br>
		<h4>Image 09: Add new FTP site context menu</h4>
		<img src="/post4/AzureVMAddFTP.jpg"/>
		
		</br>
		</br>
		<h4>Image 10: Add FTP Site binding</h4>
		<img src="/post4/AzureVMAddFTP2.jpg"/>
		
		<div>Now we will use another computer for connecting to the FTP server. I’m going to use FileZilla as FTP client application. Using FileZilla is pretty straight forward. There are four textboxes in the main window. The host, username, password and port number. Let’s fill this stuff. Host value is public IP (Public IP is written on the virtual machine desktop) of our virtual machine, username is “ftpuser”, password is password :-) and port is “21”. Click Quickconnect. Here we go. We have got first error.</div>
		
		</br>
		</br>
		<h4>Image 11: It is not possible to connect the FTP server</h4>
		<img src="/post4/AzureVMFileZillaError.jpg"/>

		<div>Ok, we need to fix this. Open IIS and go to the kpjs_deploy site. Here open FTP Firewall Support and enter Public IP there (Public IP is written on the virtual machine desktop). Then we need to go to the top node KPJSBLOGVM and open FTP Firewall Support from this place. There is “Data Channel Port Range” text box. Enter “5000-5000” range there. Don’t forget to click the Apply button. Finally we need to restart FTP service. Why do we need to do this? What is the problem about? You can get detailed explanation here: </div>
		<a href="http://grantcurell.com/2013/12/31/failed-to-retrieve-directory-listing-filezilla-connecting-to-iis-behind-nat/">LINK</a>
		<div>Good, the last step  we need to do is to setup FTP data port on Azure. Open Azure portal, go to “Virtual Machines”, open our virtual machine management and go to “Endpoints” tab. Here click on the “Add” button. Configure endpoint settings according to the following picture:</div>
		
		</br>
		</br>
		<h4>Image 12: Configure new endpoint</h4>
		<img src="/post4/AzureVMFtpDataEndpoint.jpg"/>
		
		<div>Let’s go back to FileZilla and retry to connect. This time we are successful. Connection to the FTP server is established.</div>
		
		</br>
		</br>
		<h4>Image 13: Connection successful</h4>
		<img src="/post4/AzureVMFileZilla2.jpg"/>

		<h2>Setup travis</h2>
		<div>We are using Travis continues integration system. So we need to tell Travis to copy source code of our blog app to our virtual machine somehow. Let’s look into Travis documentation: </div>
		<a href="http://docs.travis-ci.com/user/deployment/custom/">LINK</a>
		<div>So we need to add “after_success” node to the .travis.yml. There is one problem. Documentation mentioned “curl” command to copy file from Travis. This is not the best solution for us because “curl” can copy only one specified file. We have a lot of files and we don’t want to write down the name of each of them. So we need to find another solution. We are going to use Gulp. Gulp is a fast and intuitive streaming build tool built on Node.js. Check 
		<a href="http://gulpjs.com/">LINK</a>
		for more information.</div>
		<div>So basically we are going to create gulp script for copying files and we will execute this script using “after_success” node of “.travis.yml” file. </div>
		<div>Let’s create gulpfile.js file and write down following script:</div>
		<pre>
var ftp = require('vinyl-ftp');
var gulp = require('gulp');
var gutil = require('gulp-util');
var minimist = require('minimist');
var args = minimist(process.argv.slice(2));

gulp.task('deploy', function() {
  var remotePath = '/kpjs_deploy/';
  var conn = ftp.create({
    host: args.address,
    user: args.user,
    password: args.password, 
    log: gutil.log
  });
 
  gulp.src(['./**','!./node_modules','!./node_modules/**'])
    .pipe(conn.newer(remotePath))
    .pipe(conn.dest(remotePath));
});
		</pre>
		<div>Ok, let’s quickly go through it. We are creating Gulp “deploy” task there. The “remotePath” variable defines folder on our virtual machine where we are willing to copy the files. Information such as address, user name and password is coming in through parameters. Finally in gulp.src command we specified that we want to copy all files from directory except “node_modules” folder.</div>
		<div>We need to modify package.json to provide gulp required dependencies:</div>
		<pre>
"devDependencies": {
"gulp": "^3.9.0",
"gulp-util": "^3.0.6",
"minimist": "^1.2.0",
"vinyl-ftp": "^0.4.5"
}
		</pre>
		<div>Finally we need to say Travis to run our gulp script. So let’s modify our “.travis.yml”:</div>
		<pre>
env:
  global:
  - FTP_ADDRESS=104.41.201.75
  - FTP_USER=ftpuser
  - FTP_PASSWORD=nbu.sr.123
after_success: gulp deploy --address $FTP_ADDRESS --user $FTP_USER --password $FTP_PASSWORD
		</pre>
		<div>Ups! Mentioning our super-secret “FTP_PASSWORD” is not very sexy. Fortunately Travis can help us again. Let’s study documentation:
		<a href="http://docs.travis-ci.com/user/encryption-keys/">LINK</a> 
		So let’s follow the documentation orders and we will end up with something like this:</div>
		<pre>
env:
  global:
  - FTP_ADDRESS=104.41.201.75
  - FTP_USER=ftpuser
  - secure: FMzsM6zZ4/lhNr7UvN2cF5kLzd1BMt8ynmqRXDM7eBA8r6slaH
			UpNGmD955q9o6D6QcC3RA90d2ECEPaIDUZEeKWcPKvzyZ+OSD2
			AlIq1ufaLpqWKqAhgjZo+bbujoAIMwtDwq48edGAaw2bE//Ge/
			O9xObn83USzMWZceNtnT0uZwHB79SqYHQuKqdjvQLz6Mr84G9X
			73XdJ8Vi8yqXG2x4ceNJ6KDmlWgjPJzjgJ43tlCEkiuhUDkor0
			Qg4Lqm+XwTPrZyYEfGEFza4xvP5bxE8U1pOEOg6SGNWAhCaGP0
			013VoIN7alUc73ZMbkQffKOkN3fwKqnkbp0pJVWajEwiK53RD6
			SJonSDJeOoBy5qtcphTF4GQqFP9Ndhax6VrjKAW8/Tu1Te1/T0
			65LPAoTeE79c2VmeMZ2CJH0bQEP+8D9J/6CfkD8FEI2oRE/kjd
			7+B2v+zNwVu3PBdAAEVQyGJk1k/7lmObBFgSRg+KpsGFPf5YMN
			yySOUtg2LmXj+zmDF+zB/NI4Ta1d4DnF1CHJtsHe12xLIz+NAk
			m9ZT0Xta19Ba3ABG6BzQ1VkVIS4cLRIdu+JYFjPPQJ+igDodRh
			t68SdxQYPv3D4JpRaVZml/YDz5gnsxv5ECexvfA6nzcFN7i2Bj
			d91lobMlSrD0M4tCoV/hNEOCgHfF6BrlU=
after_success: gulp deploy --address $FTP_ADDRESS --user $FTP_USER --password $FTP_PASSWORD 
		</pre>
		<div>This is super cool. We are ready for “commit”.</div>

		</br>
		</br>
		<h4>Image 14: Travis output</h4>
		<img src="/post4/AzureVMTravisOutput.jpg"/>

		<div>The picture above shows that everything is copied to the virtual machine. We are ready for the last step. </div>
		
		<h2>Run it</h2>
		<div>The source code is there. We need to run it. We will install two new things on our virtual machine. Node.js and nodemon. I prefer to use chocolatey (<a href="https://chocolatey.org/">LINK</a>) to install stuff so let’s use it.</div>
		<pre>
C:\Users\vaclav>choco install nodejs.install
Installing the following packages:
nodejs.install
By installing you accept licenses for the packages.

nodejs.install v4.1.2
The package nodejs.install wants to run 'chocolateyInstall.ps1'.
Note: If you don't run this script, the installation will fail.
Note: To confirm automatically next time, use '-y' or consider setting
 'allowGlobalConfirmation'. Run 'choco feature -h' for more details.
Do you want to run the script?
 1) yes
 2) no
 3) print
1
 Downloading nodejs.install 64 bit
   from 'https://nodejs.org/dist/v4.1.2/node-v4.1.2-x64.msi'
 Installing nodejs.install...
 nodejs.install has been installed.
 The install of nodejs.install was successful.

Chocolatey installed 1/1 package(s). 0 package(s) failed.
 See the log for details (C:\ProgramData\chocolatey\logs\chocolatey.log).

PS C:\Users\vaclav> npm install -g nodemon
npm WARN optional dep failed, continuing fsevents@1.0.2
C:\Users\vaclav\AppData\Roaming\npm\nodemon -> C:\Users\vaclav\AppData\Roaming\npm\node_modules\nodemon\bin\nodemon.js
nodemon@1.7.1 C:\Users\vaclav\AppData\Roaming\npm\node_modules\nodemon
├── undefsafe@0.0.3
├── es6-promise@3.0.2
├── debug@2.2.0 (ms@0.7.1)
├── minimatch@0.3.0 (sigmund@1.0.1, lru-cache@2.7.0)
├── touch@1.0.0 (nopt@1.0.10)
├── lodash.defaults@3.1.2 (lodash.restparam@3.6.1, lodash.assign@3.2.0)
├── ps-tree@0.0.3 (event-stream@0.5.3)
├── chokidar@1.1.0 (arrify@1.0.0, path-is-absolute@1.0.0, async-each@0.1.6, glob-parent@2.0.0, is-glob@2.0.1, is-binary-
path@1.0.1, readdirp@2.0.0, anymatch@1.3.0)
└── update-notifier@0.5.0 (is-npm@1.0.0, string-length@1.0.1, chalk@1.1.1, semver-diff@2.0.0, repeating@1.1.3, configsto
re@1.2.1, latest-version@1.0.1)
		</pre>
		<div>Final steps:</div>
		<ul style="list-style-type:disc">
			<li>Run npm install in kpjs_deploy directory</li>
			<li>Check IIS management for default web site. If it is running, stop it.</li>
			<li>Set address variable to the internal IP. Use command: $env.IPADDRESS = “xxx.xxx.xxx.xxx” in powershell</li>
			<li>Set port variable to 80. Use command: $env.PORT = 80</li>
			<li>Allow port 80 in virtual machine firewall</li>
			<li>Run nodemon app.js command in kpjs_deploy directory</li>
			<li>Enjoy!</li>
		</ul>
		
		</br>
		</br>
		<h4>Image 15: Result</h4>
		<img src="/post4/AzureVMResult.jpg"/>